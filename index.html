<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Realisasi SP2D</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Poppins',sans-serif;
  margin:0;
  padding:20px;
  background:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),
  url('rm222-mind-16.jpg') no-repeat center center fixed;
  background-size:cover;
  min-height:100vh;
}

/* HEADER */
.header-container{
  padding:20px 40px;
  border-radius:15px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(12px);
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  margin-bottom:20px;
}
.header-content{
  display:flex;
  align-items:center;
  gap:15px;
}
.logo{width:60px}
.header-text h1{
  margin:0;
  font-size:2.2rem;
  font-weight:800;
  background:linear-gradient(90deg,#0d47a1,#42a5f5,#1abc9c);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.subtext{color:#fff}

/* RUNNING TEXT */
.running-text{
  background:#013d79;
  color:#fff;
  padding:8px;
  border-radius:8px;
  margin-bottom:15px;
  overflow:hidden;
}
.running-text span{
  display:inline-block;
  padding-left:100%;
  animation:marquee 12s linear infinite;
}
@keyframes marquee{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}

/* SEARCH */
#searchInput{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-bottom:15px;
}

/* TABLE */
.table-container{
  background:rgba(255,255,255,.25);
  backdrop-filter:blur(15px);
  border-radius:15px;
  padding:15px;
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:600px;
}
th,td{
  padding:10px;
  text-align:center;
}
th{
  background:#3498db;
  color:#fff;
  position:sticky;
  top:0;
}
tr:nth-child(even){background:rgba(255,255,255,.1)}
tr:hover{background:rgba(52,152,219,.15)}

/* BUTTON */
.btn-upload{
  background:#27ae60;
  color:#fff;
  padding:6px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.btn-pdf{
  background:#3498db;
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  text-decoration:none;
}

/* PAGINATION */
.pagination{text-align:center;margin-top:15px}
.pagination button{
  background:#3498db;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
}
.pagination select{padding:4px}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#27ae60;
  color:#fff;
  padding:10px 15px;
  border-radius:10px;
  animation:fadeout 3s forwards;
}
@keyframes fadeout{
  0%{opacity:1}
  100%{opacity:0}
}

/* LOADER */
.loader{
  position:fixed;
  top:50%;
  left:50%;
  width:50px;
  height:50px;
  border:5px solid #ccc;
  border-top:5px solid #3498db;
  border-radius:50%;
  animation:spin 1s linear infinite;
  display:none;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* PREVIEW MODAL */
.preview-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.preview-box{
  background:#fff;
  padding:15px;
  border-radius:15px;
  width:90%;
  max-width:500px;
}
.preview-content iframe{
  width:100%;
  height:400px;
}
.preview-content img{
  max-width:100%;
}
.preview-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.preview-actions button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
}
.btn-confirm{background:#27ae60;color:#fff}
.btn-cancel{background:#e74c3c;color:#fff}
</style>
</head>

<body>

<div class="header-container">
  <div class="header-content">
    <img src="800px-Lambang_Kabupaten_Blitar.webp.png" class="logo">
    <div class="header-text">
      <h1>ARSIP DIGITAL SP2D</h1>
      <p class="subtext">Subbag Keuangan Disperindag Kab. Blitar</p>
    </div>
  </div>
</div>

<div class="running-text">
  <span>Selamat Datang di Arsip Digital SP2D | Upload PDF / Scan Kamera</span>
</div>

<input type="text" id="searchInput" placeholder="Cari data...">

<div id="loader" class="loader"></div>

<div class="table-container">
  <table id="tabelData"></table>
  <div class="pagination">
    <button id="prevBtn">Prev</button>
    <span id="pageInfo"></span>
    <button id="nextBtn">Next</button>
    <select id="rowsPerPageSelect">
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
    </select>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div class="preview-modal" id="previewModal">
  <div class="preview-box">
    <h3>Preview Dokumen</h3>
    <div class="preview-content" id="previewContent"></div>
    <div class="preview-actions">
      <button class="btn-confirm" id="confirmUpload">Upload</button>
      <button class="btn-cancel" onclick="closePreview()">Batal</button>
    </div>
  </div>
</div>

<script>
const apiUrl="https://script.google.com/macros/s/AKfycbxVfzTEgaWljYKe4V2IUhBSO4I0DjUa1CzcEkcxbaoR5eopO2Kd1oQY82MzKFgBhsQ/exec";
let allRows=[],filteredRows=[],currentPage=1,rowsPerPage=10;
let selectedFile=null,selectedNomor=null;

function showToast(msg){
  const t=document.createElement("div");
  t.className="toast";
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}
function showLoader(){loader.style.display="block"}
function hideLoader(){loader.style.display="none"}

function renderTable(){
  let html="<tr>";
  allRows[0].forEach(h=>html+=`<th>${h}</th>`);
  html+="<th>Aksi</th></tr>";

  const start=(currentPage-1)*rowsPerPage;
  const rows=filteredRows.slice(start,start+rowsPerPage);

  rows.forEach((r,i)=>{
    html+="<tr>";
    r.forEach(c=>{
      if(typeof c==="string"&&c.startsWith("http"))
        html+=`<td><a href="${c}" target="_blank" class="btn-pdf">PDF</a></td>`;
      else html+=`<td>${c||""}</td>`;
    });

    const id=`file_${start+i}`;
    html+=`<td>
      <input type="file" id="${id}" accept="application/pdf,image/*" capture="environment"
      style="display:none" onchange="handlePreview(this,'${r[0]}')">
      <button class="btn-upload" onclick="document.getElementById('${id}').click()">Upload / Scan</button>
    </td></tr>`;
  });

  tabelData.innerHTML=html;
  pageInfo.textContent=`Hal ${currentPage}`;
}

function handlePreview(input,nomor){
  selectedFile=input.files[0];
  selectedNomor=nomor;
  if(!selectedFile)return;

  previewContent.innerHTML="";
  if(selectedFile.type==="application/pdf"){
    previewContent.innerHTML=`<iframe src="${URL.createObjectURL(selectedFile)}"></iframe>`;
  }else{
    const r=new FileReader();
    r.onload=()=>previewContent.innerHTML=`<img src="${r.result}">`;
    r.readAsDataURL(selectedFile);
  }
  previewModal.style.display="flex";
}

function closePreview(){
  previewModal.style.display="none";
  selectedFile=null;
  selectedNomor=null;
}

confirmUpload.onclick=()=>{
  const r=new FileReader();
  r.onload=async()=>{
    showLoader();
    await fetch(apiUrl,{
      method:"POST",
      body:new URLSearchParams({
        file:r.result.split(",")[1],
        nomor:selectedNomor,
        mime:selectedFile.type
      })
    });
    hideLoader();
    showToast("Upload berhasil");
    location.reload();
  };
  r.readAsDataURL(selectedFile);
};

fetch(apiUrl).then(r=>r.json()).then(d=>{
  allRows=d;
  filteredRows=d.slice(1);
  renderTable();
});
</script>

</body>
</html>
